<!doctype html>
<html lang="en">
  <head>
    <!-- Leaflet.TimeDimension plugin -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js"></script>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css" />
    <link rel="stylesheet" href="css/qgis2web.css" />
    <link rel="stylesheet" href="css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="css/leaflet.photon.css" />
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>
    <title>Time Slider Map</title>
  </head>
  <body>
    <div id="map"></div>

    <!-- Core scripts -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>

    <!-- Data layers -->
    <script src="data/Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0.js"></script>
    <script src="data/Ambrosia_points_2.js"></script>
    <script src="data/Barenklau_points_3.js"></script>

    <script>
      // --- Base map setup ---
      var map = L.map("map", {
        zoomControl: false,
        maxZoom: 28,
        minZoom: 1,
      }).fitBounds([
        [47.31548691823466, 8.389302430724234],
        [47.43882016353178, 8.722555570141042],
      ]);

      var hash = new L.Hash(map);
      map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>'
      );
      var autolinker = new Autolinker({
        truncate: { length: 30, location: "smart" },
      });

      var zoomControl = L.control
        .zoom({
          position: "topleft",
        })
        .addTo(map);

      var bounds_group = new L.featureGroup([]);

      function setBounds() {}

      // --- Zurich border layer ---
      function pop_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0(
        feature,
        layer
      ) {
        var popupContent = "<table></table>";
        layer.bindPopup(popupContent);
      }

      function style_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0_0() {
        return {
          pane: "pane_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0",
          opacity: 1,
          color: "rgba(35,35,35,1.0)",
          weight: 2.0,
          fill: false,
          interactive: false,
        };
      }

      map.createPane(
        "pane_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0"
      );
      var layer_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0 =
        new L.geoJson(
          json_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0,
          {
            attribution: "",
            interactive: false,
            onEachFeature:
              pop_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0,
            style:
              style_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0_0,
          }
        );
      map.addLayer(
        layer_Zurich_bordergemeindegrenzen_ogd__up_gemeinden_ohne_seen_f_0
      );

      // --- OSM basemap ---
      map.createPane("pane_OpenStreetMap_1");
      var layer_OpenStreetMap_1 = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          pane: "pane_OpenStreetMap_1",
          opacity: 0.484,
          maxNativeZoom: 19,
        }
      ).addTo(map);

      // --- Ambrosia layer ---
      function pop_Ambrosia_points_2(feature, layer) {
        var popupContent =
          "<table>" +
          "<tr><th>Species</th><td>" +
          (feature.properties["Species"] || "") +
          "</td></tr>" +
          "<tr><th>Individuals</th><td>" +
          (feature.properties["Individuals"] || "") +
          "</td></tr>" +
          "<tr><th>Habitat</th><td>" +
          (feature.properties["Habitat"] || "") +
          "</td></tr>" +
          "</table>";
        layer.bindPopup(popupContent);
      }

      function style_Ambrosia_points_2_0(feature) {
        return {
          pane: "pane_Ambrosia_points_2",
          radius: 6,
          opacity: 1,
          color: "rgba(35,35,35,1.0)",
          weight: 1,
          fillOpacity: 1,
          fillColor: "rgba(204,230,106,1.0)",
          interactive: true,
        };
      }

      map.createPane("pane_Ambrosia_points_2");
      var layer_Ambrosia_points_2 = new L.geoJson(json_Ambrosia_points_2, {
        attribution: "",
        interactive: true,
        onEachFeature: pop_Ambrosia_points_2,
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, style_Ambrosia_points_2_0(feature));
        },
      });
      map.addLayer(layer_Ambrosia_points_2);

      // --- Time Dimension with Start & End Dates ---
      map.timeDimension = new L.TimeDimension({
        timeInterval: "1995-01-01/2025-09-01",
        period: "P1Y", // steps by year
      });

      var player = new L.TimeDimension.Player(
        {
          transitionTime: 1000,
          loop: true,
          startOver: true,
        },
        map.timeDimension
      );

      var timeDimensionControl = new L.Control.TimeDimension({
        player: player,
        timeDimension: map.timeDimension,
        position: "bottomleft",
        autoPlay: false,
        minSpeed: 0.5,
        speedStep: 0.5,
        maxSpeed: 5,
        timeSliderDragUpdate: true,
      });
      map.addControl(timeDimensionControl);

      // --- Wrap Ambrosia layer with TimeDimension ---
      var geojsonTimeLayer = L.timeDimension.layer.geoJson(layer_Ambrosia_points_2, {
        updateTimeDimension: true,
        addlastPoint: false,
        duration: null,
        updateTimeDimensionMode: "replace",
        getInterval: function (feature) {
          var start = feature.properties.BEOBACHTUN
            ? new Date(feature.properties.BEOBACHTUN)
            : null;
          var end = feature.properties.INAKTIV_DA
            ? new Date(feature.properties.INAKTIV_DA)
            : start;
          return start && end ? [start, end] : null;
        },
      });

      map.addLayer(geojsonTimeLayer);

      // --- Barenklau layer (non-temporal for now) ---
      function pop_Barenklau_points_3(feature, layer) {
        var popupContent =
          "<table>" +
          "<tr><th>Species</th><td>" +
          (feature.properties["Species"] || "") +
          "</td></tr>" +
          "<tr><th>Individuals</th><td>" +
          (feature.properties["Individuals"] || "") +
          "</td></tr>" +
          "<tr><th>Habitat</th><td>" +
          (feature.properties["Habitat"] || "") +
          "</td></tr>" +
          "</table>";
        layer.bindPopup(popupContent);
      }

      function style_Barenklau_points_3_0(feature) {
        return {
          pane: "pane_Barenklau_points_3",
          radius: 7,
          opacity: 1,
          color: "rgba(35,35,35,1.0)",
          weight: 1,
          fillOpacity: 1,
          fillColor: "rgba(114,155,111,1.0)",
          interactive: true,
        };
      }

      map.createPane("pane_Barenklau_points_3");
      var layer_Barenklau_points_3 = new L.geoJson(json_Barenklau_points_3, {
        attribution: "",
        interactive: true,
        onEachFeature: pop_Barenklau_points_3,
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, style_Barenklau_points_3_0(feature));
        },
      });
      map.addLayer(layer_Barenklau_points_3);

      setBounds();
    </script>
  </body>
</html>
